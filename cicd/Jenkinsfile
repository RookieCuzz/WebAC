pipeline {
    agent any
    
    tools {
        // éœ€æå‰åœ¨ Jenkins å…¨å±€å·¥å…·é‡Œé…ç½®å¥½ JDK å®‰è£…
        jdk 'JDK17'
    }
    
    environment {
        // å®šä¹‰ç¯å¢ƒå˜é‡
        APP_NAME = 'webac'
        REGISTRY = 'crpi-vqe38j3xeblrq0n4.cn-hangzhou.personal.cr.aliyuncs.com/spring-mctown'
    }
    
    stages {
        stage('æ£€å‡ºä»£ç ') {
            steps {
                // ä» Git ä»“åº“æ£€å‡ºä»£ç 
                checkout scm
            }
        }
        
        stage('å•å…ƒæµ‹è¯•') {
            steps {
                // è¿è¡Œå•å…ƒæµ‹è¯•
                sh './gradlew test'
            }
            post {
                always {
                    // å‘å¸ƒæµ‹è¯•æŠ¥å‘Š
                    junit '**/build/test-results/test/*.xml'
                }
            }
        }
        
        stage('ä»£ç è´¨é‡åˆ†æ') {
            steps {
                // è¿è¡Œ SonarQube åˆ†æ
                sh './gradlew sonarqube'
            }
        }
        
        stage('æ„å»ºåº”ç”¨') {
            steps {
                // ä½¿ç”¨ Gradle æ„å»ºåº”ç”¨
                sh './gradlew build -x test'
            }
            post {
                success {
                    // å½’æ¡£æ„å»ºäº§ç‰©
                    archiveArtifacts artifacts: 'build/libs/*.jar', fingerprint: true
                }
            }
        }
        
        stage('æ‰“åŒ…åº”ç”¨') {
            steps {
                // æ‰“åŒ…åº”ç”¨
                sh "cp build/libs/*.jar ${env.APP_NAME}.jar"
                sh "tar czf ${env.APP_NAME}.tar.gz ${env.APP_NAME}.jar"
            }
        }
        
        stage('å½’æ¡£') {
            steps {
                archiveArtifacts artifacts: "${env.APP_NAME}.tar.gz"
            }
        }
        
        stage('Docker æ„å»ºä¸æ¨é€') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'aliyun-docker-login',
                    usernameVariable: 'DOCKER_USERNAME',
                    passwordVariable: 'DOCKER_PASSWORD'
                )]) {
                    sh """
                        echo "\$DOCKER_PASSWORD" | docker login --username \$DOCKER_USERNAME --password-stdin ${env.REGISTRY.split('/')[0]}
                    """
                }
                
                script {
                    def imageTag = "${env.REGISTRY}/${env.APP_NAME}:${env.BUILD_NUMBER}"
                    def latestTag = "${env.REGISTRY}/${env.APP_NAME}:latest"
                    
                    sh """
                        ls -l
                        docker build -t ${imageTag} --network=host -f cicd/Dockerfile .
                        docker tag ${imageTag} ${latestTag}
                        docker push ${imageTag}
                        docker push ${latestTag}
                    """
                }
            }
        }
        
        // stage('éƒ¨ç½²æ‰€æœ‰ Compose é¡¹ç›®') {
        //     parallel {
        //         stage('éƒ¨ç½²å¼€å‘ç¯å¢ƒ') {
        //             when {
        //                 branch 'develop'
        //             }
        //             agent {label 'dockeragent'}
        //             steps {
        //                 checkout scm
        //                 sh """
        //                     pwd
        //                     ls -l
        //                 """
        //                 dir('mq') {
        //                     script {
        //                         withCredentials([usernamePassword(
        //                             credentialsId: 'aliyun-docker-login',
        //                             usernameVariable: 'DOCKER_USERNAME',
        //                             passwordVariable: 'DOCKER_PASSWORD'
        //                         )]) {
        //                             sh """
        //                                 echo "\$DOCKER_PASSWORD" | docker login --username "\$DOCKER_USERNAME" --password-stdin ${env.REGISTRY.split('/')[0]}
        //                             """
        //                         }
        //                         sh """
        //                             pwd
        //                             ls -l
        //                             docker compose -f docker-compose.yml down || true
        //                             docker compose -f docker-compose.yml pull
        //                             docker compose -f docker-compose.yml up -d --remove-orphans
        //                         """
        //                     }
        //                 }
        //             }
        //         }
                
        //         stage('éƒ¨ç½²æµ‹è¯•ç¯å¢ƒ') {
        //             when {
        //                 branch 'staging'
        //             }
        //             agent {label 'dockeragent'}
        //             steps {
        //                 checkout scm
        //                 sh """
        //                     pwd
        //                     ls -l
        //                 """
        //                 dir('mq') {
        //                     script {
        //                         withCredentials([usernamePassword(
        //                             credentialsId: 'aliyun-docker-login',
        //                             usernameVariable: 'DOCKER_USERNAME',
        //                             passwordVariable: 'DOCKER_PASSWORD'
        //                         )]) {
        //                             sh """
        //                                 echo "\$DOCKER_PASSWORD" | docker login --username "\$DOCKER_USERNAME" --password-stdin ${env.REGISTRY.split('/')[0]}
        //                             """
        //                         }
        //                         sh """
        //                             pwd
        //                             ls -l
        //                             docker compose -f docker-compose.yml down || true
        //                             docker compose -f docker-compose.yml pull
        //                             docker compose -f docker-compose.yml up -d --remove-orphans
        //                         """
        //                     }
        //                 }
        //             }
        //         }
                
        //         stage('éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ') {
        //             when {
        //                 branch 'main'
        //             }
        //             agent {label 'dockeragent'}
        //             steps {
        //                 // æ‰‹åŠ¨ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
        //                 input message: 'ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ?', ok: 'éƒ¨ç½²'
                        
        //                 checkout scm
        //                 sh """
        //                     pwd
        //                     ls -l
        //                 """
        //                 dir('mq') {
        //                     script {
        //                         withCredentials([usernamePassword(
        //                             credentialsId: 'aliyun-docker-login',
        //                             usernameVariable: 'DOCKER_USERNAME',
        //                             passwordVariable: 'DOCKER_PASSWORD'
        //                         )]) {
        //                             sh """
        //                                 echo "\$DOCKER_PASSWORD" | docker login --username "\$DOCKER_USERNAME" --password-stdin ${env.REGISTRY.split('/')[0]}
        //                             """
        //                         }
        //                         sh """
        //                             pwd
        //                             ls -l
        //                             docker compose -f docker-compose.yml down || true
        //                             docker compose -f docker-compose.yml pull
        //                             docker compose -f docker-compose.yml up -d --remove-orphans
        //                         """
        //                     }
        //                 }
        //             }
        //         }
        //     }
        // }
    }
    
    post {
        always {
            cleanWs()
        }
        success {
            echo "âœ… æ„å»ºæˆåŠŸï¼"
        }
        failure {
            echo "ğŸ”¥ æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚"
        }
    }
}